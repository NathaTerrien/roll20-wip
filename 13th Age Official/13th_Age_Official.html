<div class="container">
    <input class="options-check" type="checkbox" name="attr_options-check" checked="checked" title="Show/hide options" /><span></span>
    <div class="options">
        <span class="row" style="font-size: 20px; margin-bottom: 10px;">
            Options
        </span>
        <div>
            <div style="width: 250px; margin-bottom: 4px;display: inline-block;">
                <span class="row">
                    <span>Base AC from class</span><input type="number" name="attr_AC-base" value="10" title="@{AC-base}" />
                </span>
                <span class="row">
                    <span>Base PD from class</span><input type="number" name="attr_PD-base" value="10" title="@{PD-base}" />
                </span>
                <span class="row">
                    <span>Base MD from class</span><input type="number" name="attr_MD-base" value="10" title="@{MC-base}" />
                </span>
            </div>
            <div style="width: 450px; display: inline-block; vertical-align: top;color: #666;">
                <span class="row">
                    These are base numbers necessary for the automatic calculations below to work. After you've input these numbers you're encouraged to click on the gear icon in the upper right hand corner to hide this section.
                </span>
            </div>
        </div>
        <div>
            <div style="width: 250px; margin-bottom: 4px;display: inline-block;">
                <span class="row">
                    <span class="lib">Base HP from class</span><input type="number" name="attr_HP-base" value="7" title="@{HP-base}" />
                </span>
                <span class="row">
                    <span class="lib">Melee Basic Attack Based On</span>
                        <select name="attr_M-BAMOD">
                            <option value="@{STR-mod}" selected="selected">STR</option>
                            <option value="@{DEX-mod}">DEX</option>
                        </select>
                </span>
                <span class="row">
                    <span class="lib">Ranged Basic Attack Based On</span>
                        <select name="attr_R-BAMOD">
                            <option value="@{STR-mod}">STR</option>
                            <option value="@{DEX-mod}" selected="selected">DEX</option>
                        </select>
                </span>
            </div>
            <div style="width: 250px; display: inline-block; vertical-align: top;">
                <span class="row">
                    <span class="lib">Flat HP Mod from Magic Items</span><input type="number" name="attr_HP-mod" value="0" title="@{HP-mod}" />
                </span>
                <span class="row">
                    <span class="lib">Damage on Melee Miss</span>
                        <select name="attr_M-MISS">
                            <option value="0">-</option>
                            <option value="@{level}" selected="selected">Level</option>
                        </select>
                </span>
                <span class="row">
                    <span class="lib">Damage on Ranged Miss</span>
                        <select name="attr_R-MISS">
                            <option value="0" selected="selected">-</option>
                            <option value="@{level}">Level</option>
                        </select>
                </span>
            </div>
            <div style="width: 200px; display: inline-block; vertical-align: top;">
                <span class="row">
                    <span class="lib">Flat Initiative Mod</span><input type="number" name="attr_INIT-mod" value="0" title="@{INIT-mod}" />
                </span>
            </div>
        </div>
    </div>
    <div class="header">
        <div class="meta">
            <div class="metacontainer">
                <div class="label">Name</div>
                <input type="text" name="attr_character_name" title="@{character_name}" />
            </div>
            <div class="metacontainer">
                <div class="label">Race</div>
                <input type="text" name="attr_race" title="@{race}" />
            </div>
            <div class="metacontainer">
                <div class="label">Class</div>
                <input type="text" name="attr_class" title="@{class}" />
            </div>
            <div class="metacontainer">
                <div class="label">Level</div>
                <input type="number" name="attr_level" value="1" title="@{level}" />
            </div>
        </div>
        <div class="attributes">
            <div class="attrcontainer">
                <input class="attrbase" type="text" name="attr_STR-base" value="10" title="@{STR-base}" />
                <button class="attrlabel" type="roll" name="roll_STR" value="&{template:attr} {{attr=Strength}} {{attr_abr=STR}} {{attr_bonus=[[[[@{STR-mod}]][STR]]]}} {{level=@{level}}} {{mod=[[?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{result=[[1d20 + [[@{STR-mod}]][STR] + @{level}[LVL] + ?{Modifiers|0}[MOD] + @{BACK-final}">STR</button>
                <span class="attrmod" name="attr_STR-mod" title="@{STR-mod}"></span>
            </div>
            <div class="attrcontainer">
                <input class="attrbase" type="text" name="attr_CON-base" value="10" title="@{CON-base}" />
                <button class="attrlabel" type="roll" name="roll_CON" value="&{template:attr} {{attr=Constitution}} {{attr_abr=CON}} {{attr_bonus=[[[[@{CON-mod}]][CON]]]}} {{level=@{level}}} {{mod=[[?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{result=[[1d20 + [[@{CON-mod}]][CON] + @{level}[LVL] + ?{Modifiers|0}[MOD] + @{BACK-final}">CON</button>
                <span class="attrmod" name="attr_CON-mod" title="@{CON-mod}"></span>
            </div>
            <div class="attrcontainer" style="position: absolute;">
                <input class="attrbase" type="text" name="attr_DEX-base" value="10" title="@{DEX-base}" />
                <button class="attrlabel" type="roll" name="roll_DEX" value="&{template:attr} {{attr=Dexterity}} {{attr_abr=DEX}} {{attr_bonus=[[[[@{DEX-mod}]][DEX]]]}} {{level=@{level}}} {{mod=[[?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{result=[[1d20 + [[@{DEX-mod}]][DEX] + @{level}[LVL] + ?{Modifiers|0}[MOD] + @{BACK-final}">DEX</button>
                <span class="attrmod" name="attr_DEX-mod" title="@{DEX-mod}"></span>
                <button class="init" type="roll" name="roll_INIT" value="&{template:init} {{name=@{selected|token_name}}} {{dex_bonus=[[[[@{DEX-mod}]][DEX]]]}} {{level=@{level}}} {{mod=[[@{INIT-mod}+?{Modifiers|0}]]}} {{result=[[1d20 + [[@{DEX-mod}]][DEX] + @{level}[LVL] + @{INIT-mod} + ?{Modifiers|0}[MOD] &{tracker}]]}}">INITIATIVE</button>
            </div>
        </div>
        <div class="attributes">
            <div class="attrcontainer">
                <input class="attrbase" type="text" name="attr_INT-base" value="10" title="@{INT-base}" />
                <button class="attrlabel" type="roll" name="roll_INT" value="&{template:attr} {{attr=Intelligence}} {{attr_abr=INT}} {{attr_bonus=[[[[@{INT-mod}]][INT]]]}} {{level=@{level}}} {{mod=[[?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{result=[[1d20 + [[@{INT-mod}]][INT] + @{level}[LVL] + ?{Modifiers|0}[MOD] + @{BACK-final}">INT</button>
                <span class="attrmod" name="attr_INT-mod" title="@{INT-mod}"></span>
            </div>
            <div class="attrcontainer">
                <input class="attrbase" type="text" name="attr_WIS-base" value="10" title="@{WIS-base}" />
                <button class="attrlabel" type="roll" name="roll_WIS" value="&{template:attr} {{attr=Wisdom}} {{attr_abr=WIS}} {{attr_bonus=[[[[@{WIS-mod}]][WIS]]]}} {{level=@{level}}} {{mod=[[?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{result=[[1d20 + [[@{WIS-mod}]][WIS] + @{level}[LVL] + ?{Modifiers|0}[MOD] + @{BACK-final}">WIS</button>
                <span class="attrmod" name="attr_WIS-mod" title="@{WIS-mod}"></span>
            </div>
            <div class="attrcontainer" style="position: relative;">
                <input class="attrbase" type="text" name="attr_CHA-base" value="10" title="@{CHA-base}" />
                <button class="attrlabel" type="roll" name="roll_CHA" value="&{template:attr} {{attr=Charisma}} {{attr_abr=CHA}} {{attr_bonus=[[[[@{CHA-mod}]][CHA]]]}} {{level=@{level}}} {{mod=[[?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{result=[[1d20 + [[@{CHA-mod}]][CHA] + @{level}[LVL] + ?{Modifiers|0}[MOD] + @{BACK-final}">CHA</button>
                <span class="attrmod" name="attr_CHA-mod" title="@{CHA-mod}"></span>
                <div class="deathsavecontainer">
                    <button class="init" type="roll" name="roll_DEATHSAVE" value="&{template:deathsave} {{result=[[1d20]]}}">DEATH SAVE</button>
                    <input type="checkbox" name="attr_DEATHSAVE1" />
                    <input type="checkbox" name="attr_DEATHSAVE2" />
                    <input type="checkbox" name="attr_DEATHSAVE3" />
                    <input type="checkbox" name="attr_DEATHSAVE4" />
                </div>
            </div>
        </div>
        <div class="derived">
            <div class="dercontainer">
                <button class="derlabel" type="roll" name="roll_AC" value="">AC</button>
                <span class="derbubble" name="attr_AC" title="@{AC}"></span>
            </div>
            <div class="dercontainer">
                <button class="derlabel" type="roll" name="roll_PD" value="">PD</button>
                <span class="derbubble" name="attr_PD" title="@{PD}"></span>
            </div>
            <div class="dercontainer">
                <button class="derlabel" type="roll" name="roll_MD" value="">MD</button>
                <span class="derbubble" name="attr_MD" title="@{MD}"></span>
            </div>
        </div>
        <div class="derived">
            <div class="dercontainer">
                <span class="derlabel hp">Max HP</span>
                <span class="derived" name="attr_HP_max" title="@{HP_max}"></span>
                <span class="derlabel hp stag">Staggered</span>
                <span class="derived" name="attr_HP-staggered" title="@{HP-staggered}"></span>
            </div>
            <div class="dercontainer">
                <div class="hpbox">
                    <div class="left subbox">
                        <input type="text" name="attr_HP" title="@{HP}" />
                        <span>Current HP</span>
                    </div>
                    <div class="right subbox">
                        <input type="text" name="attr_HP-temp" title="@{HP-temp}" />
                        <span>Temp HP</span>
                    </div>
                </div>
            </div>
            <div class="dercontainer" style="margin-top:-5px;">
                <button class="derlabel recovery" type="roll" name="roll_recovery" value="&{template:rec} {{name=@{character_name}}} {{rec_die=@{REC-die}}} {{con_bonus=[[[[@{REC-bonus}]][CON]]]}} {{level=@{level}}} {{mod=[[?{Modifiers|0}]]}} {{result=[[@{level}d@{REC-die}+[[@{REC-bonus}]]+?{Modifiers|0}]]}}">Recovery</button>
                <select class="recovery" type="text" name="attr_REC-die" title="@{REC-die}">
                    <option value="4">d4</option>
                    <option value="6">d6</option>
                    <option value="8" selected="selected">d8</option>
                    <option value="10">d10</option>
                    <option value="12">d12</option>
                </select>
                <span class="derlabel" style="width: 10px; padding-right:0; margin-left:-5px; border-left:0px; border-right:0px;">+</span>
                <input class="recovery" type="text" style="width:32px;" name="attr_REC-bonus" title="@{REC-bonus}" value="0" />
                <span class="derlabel" style="width: 7px; margin-left: -9px;">Max</span>
                <input class="recovery recmax" type="text" style="border-left:0px; width:31px;" name="attr_REC_max" value="8" title="@{REC_max}" />
                <span class="recoverycontainer">
                    <input class="recflag" name="attr_rec_flag" type="hidden" value="8" />
                    <input type="radio" class="sheet-normal 0" name="attr_REC" value="0" /><span></span>
                    <input type="radio" class="sheet-normal 1" name="attr_REC" value="1" /><span></span>
                    <input type="radio" class="sheet-normal 2" name="attr_REC" value="2" /><span></span>
                    <input type="radio" class="sheet-normal 3" name="attr_REC" value="3" /><span></span>
                    <input type="radio" class="sheet-normal 4" name="attr_REC" value="4" /><span></span>
                    <input type="radio" class="sheet-normal 5" name="attr_REC" value="5" /><span></span>
                    <input type="radio" class="sheet-normal 6" name="attr_REC" value="6" /><span></span>
                    <input type="radio" class="sheet-normal 7" name="attr_REC" value="7" /><span></span>
                    <input type="radio" class="sheet-normal 8" name="attr_REC" value="8" checked="checked" /><span></span>
                    <input type="radio" class="sheet-normal 9" name="attr_REC" value="9" /><span></span>
                    <input type="radio" class="sheet-normal 10" name="attr_REC" value="10" /><span></span>
                </span>
            </div>

        </div>
    </div>

    <div class="body">
        <div class="col column1">
            <div class="bodycontainer">
                <div class="logo"></div>
            </div>
            <div class="bodycontainer">
                <div class="header">One Unique Thing</div>
                <textarea name="attr_OUT"></textarea>
            </div>
            <div class="bodycontainer" style="margin-bottom: 10px;">
                <div class="header">
                    <button class="attrlabel" type="roll" name="roll_icon" value="&{template:icon} {{icon1=[[1d6cf5]]}} {{icon2=[[1d6cf5]]}} {{icon3=[[1d6cf5]]}} {{icon4=[[1d6cf5]]}} {{charname=@{character_name}}} @{icon-final}">Icon Relationships</button>
                </div>
                <div class="iconrelationship">
                    <input type="radio" class="iconrelationship" name="attr_icon-final" value="{{name=@{icon-name1}}} {{relationship=@{icon-type1}}} {{iconlvl=[[@{icon1}]]}} {{iconrow=1}}" checked="checked" />
                    <input type="text" class="title" name="attr_icon-name1" placeholder="Orc Lord" />
                    <input type="text" class="iconrelationship short" name="attr_icon1" placeholder="1" />
                    <div class="subicon">
                        <select class="iconrelationship" name="attr_icon-type1">
                            <option value="Positive">Positive</option>
                            <option value="Conflicted">Conflicted</option>
                            <option value="Negative">Negative</option>
                        </select>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon1-5-count" />
                        <input type="checkbox" name="attr_icon1-5" /><span class="pictos">e</span>
                        <input type="checkbox" name="attr_icon1-6" /><span class="pictos">k</span>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon1-6-count" />
                    </div>
                </div>
                <div class="iconrelationship">
                    <input type="radio" class="iconrelationship" name="attr_icon-final" value="{{name=@{icon-name2}}} {{relationship=@{icon-type2}}} {{iconlvl=[[@{icon2}]]}} {{iconrow=2}}" />
                    <input type="text" class="title" name="attr_icon-name2" />
                    <input type="text" class="iconrelationship short" name="attr_icon2" />
                    <div class="subicon">
                        <select class="iconrelationship" name="attr_icon-type2">
                            <option value="Positive">Positive</option>
                            <option value="Conflicted">Conflicted</option>
                            <option value="Negative">Negative</option>
                        </select>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon2-5-count" />
                        <input type="checkbox" name="attr_icon2-5" /><span class="pictos">e</span>
                        <input type="checkbox" name="attr_icon2-6" /><span class="pictos">k</span>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon2-6-count" />
                    </div>
                </div>
                <div class="iconrelationship">
                    <input type="radio" class="iconrelationship" name="attr_icon-final" value="{{name=@{icon-name3}}} {{relationship=@{icon-type3}}} {{iconlvl=[[@{icon3}]]}} {{iconrow=3}}" />
                    <input type="text" class="title" name="attr_icon-name3" />
                    <input type="text" class="iconrelationship short" name="attr_icon3" />
                    <div class="subicon">
                        <select class="iconrelationship" name="attr_icon-type3">
                            <option value="Positive">Positive</option>
                            <option value="Conflicted">Conflicted</option>
                            <option value="Negative">Negative</option>
                        </select>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon3-5-count" />
                        <input type="checkbox" name="attr_icon3-5" /><span class="pictos">e</span>
                        <input type="checkbox" name="attr_icon3-6" /><span class="pictos">k</span>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon3-6-count" />
                    </div>
                </div>
                <div class="iconrelationship">
                    <input type="radio" class="iconrelationship" name="attr_icon-final" value="{{name=@{icon-name4}}} {{relationship=@{icon-type4}}} {{iconlvl=[[@{icon4}]]}} {{iconrow=4}}" />
                    <input type="text" class="title" name="attr_icon-name4" />
                    <input type="text" class="iconrelationship short" name="attr_icon4" />
                    <div class="subicon">
                        <select class="iconrelationship" name="attr_icon-type4">
                            <option value="Positive">Positive</option>
                            <option value="Conflicted">Conflicted</option>
                            <option value="Negative">Negative</option>
                        </select>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon4-5-count" />
                        <input type="checkbox" name="attr_icon4-5" /><span class="pictos">e</span>
                        <input type="checkbox" name="attr_icon4-6" /><span class="pictos">k</span>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon4-6-count" />
                    </div>
                </div>
                <div class="iconrelationship">
                    <input type="radio" class="iconrelationship" name="attr_icon-final" value="{{name=@{icon-name5}}} {{relationship=@{icon-type5}}} {{iconlvl=[[@{icon5}]]}} {{iconrow=5}}" />
                    <input type="text" class="title" name="attr_icon-name5" />
                    <input type="text" class="iconrelationship short" name="attr_icon5" />
                    <div class="subicon">
                        <select class="iconrelationship" name="attr_icon-type5">
                            <option value="Positive">Positive</option>
                            <option value="Conflicted">Conflicted</option>
                            <option value="Negative">Negative</option>
                        </select>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon5-5-count" />
                        <input type="checkbox" name="attr_icon5-5" /><span class="pictos">e</span>
                        <input type="checkbox" name="attr_icon5-6" /><span class="pictos">k</span>
                        <input type="text" class="iconrelationship symbolcount" name="attr_icon5-6-count" />
                    </div>
                </div>
            </div>
            <div class="bodycontainer">
                <div class="header">Equipment</div>
                <textarea name="attr_EQUIP" style="height:205px;"></textarea>
            </div>
        </div>
        <div class="col column2">
            <div class="bodycontainer">
                <div class="header">Backgrounds</div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="1" checked="checked" />
                    <input type="text" class="title" name="attr_BACK-name1" placeholder="Assassin" />
                    <input type="text" class="background" name="attr_BACK1" placeholder="2" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="2" />
                    <input type="text" class="title" name="attr_BACK-name2" />
                    <input type="text" class="background" name="attr_BACK2" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="3" />
                    <input type="text" class="title" name="attr_BACK-name3" />
                    <input type="text" class="background" name="attr_BACK3" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="4" />
                    <input type="text" class="title" name="attr_BACK-name4" />
                    <input type="text" class="background" name="attr_BACK4" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="5" />
                    <input type="text" class="title" name="attr_BACK-name5" />
                    <input type="text" class="background" name="attr_BACK5" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="6" />
                    <input type="text" class="title" name="attr_BACK-name6" />
                    <input type="text" class="background" name="attr_BACK6" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="7" />
                    <input type="text" class="title" name="attr_BACK-name7" />
                    <input type="text" class="background" name="attr_BACK7" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="8" />
                    <input type="text" class="title" name="attr_BACK-name8" />
                    <input type="text" class="background" name="attr_BACK8" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="9" />
                    <input type="text" class="title" name="attr_BACK-name9" />
                    <input type="text" class="background" name="attr_BACK9" />
                </div>
                <div class="background">
                    <input type="radio" class="background" name="attr_BACK-sel" value="10" />
                    <input type="text" class="title" name="attr_BACK-name10" />
                    <input type="text" class="background" name="attr_BACK10" />
                </div>
            </div>
            <div class="bodycontainer">
                <div class="header">Melee Weapons</div>
                <div class="weapon">
                    <input type="radio" class="weapon" name="attr_MWEAP-sel" value="1" checked="checked" />
                    <input type="text" class="title" name="attr_MWEAP-name1" placeholder="Rapier" />
                    <input type="text" class="weapon" name="attr_MWEAP-mod1" value="0" />
                    <select class="weapon" name="attr_MWEAP1" title="@{MWEAP1}">
                        <option value="0"></option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                    </select>
                </div>
                <div class="weapon">
                    <input type="radio" class="weapon" name="attr_MWEAP-sel" value="2" />
                    <input type="text" class="title" name="attr_MWEAP-name2" />
                    <input type="text" class="weapon" name="attr_MWEAP-mod2" value="0" />
                    <select class="weapon" name="attr_MWEAP2" title="@{MWEAP2}">
                        <option value="0"></option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                    </select>
                </div>
                <div class="weapon">
                    <input type="radio" class="weapon" name="attr_MWEAP-sel" value="3" />
                    <input type="text" class="title" name="attr_MWEAP-name3" />
                    <input type="text" class="weapon" name="attr_MWEAP-mod3" value="0" />
                    <select class="weapon" name="attr_MWEAP3" title="@{MWEAP3}">
                        <option value="0"></option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                    </select>
                </div>
            </div>
            <div class="bodycontainer">
                <div class="header">Ranged Weapons</div>
                <div class="weapon">
                    <input type="radio" class="weapon" name="attr_RWEAP-sel" value="1" checked="checked" />
                    <input type="text" class="title" name="attr_RWEAP-name1" />
                    <input type="text" class="weapon" name="attr_RWEAP-mod1" value="0" />
                    <select class="weapon" name="attr_RWEAP1" title="@{RWEAP1}">
                        <option value="0"></option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                    </select>
                </div>
                <div class="weapon">
                    <input type="radio" class="weapon" name="attr_RWEAP-sel" value="2">
                    <input type="text" class="title" name="attr_RWEAP-name2" />
                    <input type="text" class="weapon" name="attr_RWEAP-mod2" value="0" />
                    <select class="weapon" name="attr_RWEAP2" title="@{RWEAP2}">
                        <option value="0"></option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                    </select>
                </div>
                <div class="weapon">
                    <input type="radio" class="weapon" name="attr_RWEAP-sel" value="3" />
                    <input type="text" class="title" name="attr_RWEAP-name3" />
                    <input type="text" class="weapon" name="attr_RWEAP-mod3" value="0" />
                    <select class="weapon" name="attr_RWEAP3" title="@{RWEAP3}">
                        <option value=""></option>
                        <option value="4">d4</option>
                        <option value="6">d6</option>
                        <option value="8">d8</option>
                        <option value="10">d10</option>
                        <option value="12">d12</option>
                    </select>
                </div>
            </div>
            <div class="bodycontainer">
                <div class="header">Talents & Features</div>
                <textarea name="attr_TAL-FEA" style="height:345px;"></textarea>
            </div>
        </div>
        <div class="col column3">
            <div class="power">
                <div class="header atwill">
                    <button class="powerlabel" type="roll" name="roll_MBA" value="&{template:ba} {{range=Nearby}} {{miss=@{MBA-miss}}} @{MWEAP-final}">Melee Basic Attack</button>
                    <span class="right">
                        <span>At-Will</span>
                    </span>
                </div>
                <div class="body">
                    <span class="row">
                        <span class="left bold">Standard Action</span>
                        <span class="right bold">Nearby</span>
                    </span>
                    <span class="row">
                        <span class="left"><b>Target:</b> One creature</span>
                        <span class="right ba-attack">
                            <b>Attack:</b>
                            <span class="stat" name="attr_MBA-attackvs" title="@{MBA-attackvs}"></span>
                        </span>
                    </span>
                    <span class="row">
                        <span class="left ba-hit">
                            <b>Hit:</b>
                            <span class="stat" name="attr_MBA-hit" title="@{MBA-hit}"></span>
                        </span>
                        <span class="right">
                            <b>Miss:</b>
                            <span class="stat" name="attr_MBA-miss" title="@{MBA-miss}"></span>
                        </span>
                    </span>
                </div>
            </div>
            <div class="power">
                <div class="header atwill">
                    <button class="powerlabel" type="roll" name="roll_RBA" value="&{template:ba} {{range=One enemy}} {{miss=@{RBA-miss}}} @{RWEAP-final}">Ranged Basic Attack</button>
                    <span class="right">
                        <span>At-Will</span>
                    </span>
                </div>
                <div class="body">
                    <span class="row">
                        <span class="left bold">Standard Action</span>
                        <span class="right bold">One enemy</span>
                    </span>
                    <span class="row">
                        <span class="left"><b>Target:</b> One creature</span>
                        <span class="right ba-attack">
                            <b>Attack:</b>
                            <span class="stat" name="attr_RBA-attackvs" title="@{RBA-attackvs}"></span>
                        </span>
                    </span>
                    <span class="row">
                        <span class="left ba-hit">
                            <b>Hit:</b>
                            <span class="stat" name="attr_RBA-hit" title="@{RBA-hit}"></span>
                        </span>
                        <span class="right">
                            <b>Miss:</b>
                            <span class="stat" name="attr_RBA-miss" title="@{RBA-miss}"></span>
                        </span>
                    </span>
                </div>
            </div>

            <fieldset class="repeating_power">
                <div class="power">
                    <!-- OPTIONS -->
                    <input class="poweroptions-check" type="checkbox" name="attr_poweroptions-check" checked="checked" /><span></span>
                    <span class="poption topspacer">Options</span>
                    <span class="poption">Name:</span>
                    <input class="poption title" type="text" name="attr_name" />
                        <span class="poption spacer"></span>
                    <span class="poption">Type:</span>
                        <input class="poption At-Will" type="radio" name="attr_type" value="atwill" checked="checked" /><span class="poption">At-Will</span>
                        <input class="poption Class" type="radio" name="attr_type" value="class" /><span class="poption">Class</span>
                        <input class="poption Racial" type="radio" name="attr_type" value="racial" /><span class="poption">Racial</span>
                        <input class="poption Encounter" type="radio" name="attr_type" value="encounter" /><span class="poption">Encounter</span>
                        <input class="poption Recharge" type="radio" name="attr_type" value="recharge" /><span class="poption">Recharge</span>
                        <input class="poption Daily" type="radio" name="attr_type" value="daily" /><span class="poption">Daily</span>
                        <input class="poption Spell" type="radio" name="attr_type" value="spell" /><span class="poption">Spell</span>
                        <input class="poption Magic-Item" type="radio" name="attr_type" value="magicitem" /><span class="poption">Magic Item</span>
                        <input class="poption Custom" type="radio" name="attr_type" value="custom" /><span class="poption">Custom</span>
                        <input class="poption title full" type="text" name="attr_type-custom" placeholder="Custom" />
                            <span class="spacer suboption classtype"></span>
                            <input class="suboption classtype" type="radio" name="attr_classtype" value="Talent" checked="checked" /><span class="suboption classtype">Talent</span>
                            <input class="suboption classtype" type="radio" name="attr_classtype" value="Feature" /><span class="suboption classtype">Feature</span>
                            <input class="suboption classtype" type="radio" name="attr_classtype" value="Power" /><span class="suboption classtype">Power</span>
                            <input class="suboption classtype" type="radio" name="attr_classtype" value="Battle Cry" /><span class="suboption classtype">Battle Cry</span>
                            <input class="suboption classtype" type="radio" name="attr_classtype" value="Domain" /><span class="suboption classtype">Domain</span>
                            <span class="suboption rechargerate">Recharge Rate</span><input class="suboption rechargerate num" type="text" name="attr_rechargerate" />
                        <span class="poption spacer"></span>
                    <input class="poption Uses" type="checkbox" name="attr_uses" value="@{uses-type}" /><span class="poption">Uses:</span>
                        <input class="suboption usesoptions 1" type="radio" name="attr_uses-type" value="1" /><span class="suboption usesoptions">1</span>
                        <input class="suboption usesoptions 2" type="radio" name="attr_uses-type" value="2" /><span class="suboption usesoptions">2</span>
                        <input class="suboption usesoptions 3" type="radio" name="attr_uses-type" value="3" /><span class="suboption usesoptions">3</span>
                        <input class="suboption usesoptions 4" type="radio" name="attr_uses-type" value="4" /><span class="suboption usesoptions">4</span>
                        <span class="poption spacer"></span>
                    <input class="poption Action" type="checkbox" name="attr_action" value="1" /><span class="poption">Action:</span>
                        <select class="suboption actionoptions" name="attr_action-type">
                            <option value="Standard Action">Standard Action</option>
                            <option value="Move Action">Move Action</option>
                            <option value="Quick Action">Quick Action</option>
                            <option value="Free Action">Free Action</option>
                            <option value="Flexible Action">Flexible Action</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <input class="suboption actionoptions title" type="text" name="attr_action-custom" style="width:55px;" placeholder="Custom" />
                        <span class="poption spacer"></span>
                    <input class="poption Range" type="checkbox" name="attr_range" value="1" /><span class="poption">Range:</span>
                        <select class="suboption rangeoptions" name="attr_range-type">
                            <option value="Engaged">Engaged</option>
                            <option value="Nearby">Nearby</option>
                            <option value="Far Away">Far Away</option>
                            <option value="Intercepting">Intercepting</option>
                            <option value="Line of Sight">Line of Sight</option>
                            <option value="Custom">Custom</option>
                        </select>
                        <input class="suboption rangeoptions title" type="text" name="attr_range-custom" style="width:55px;" placeholder="Custom" />
                        <span class="poption spacer"></span>
                    <input class="poption Target" type="checkbox" name="attr_target" value="1" /><span class="poption">Target:</span>
                        <input class="suboption targetoptions title" type="text" name="attr_target-type" style="width:160px;" />
                        <span class="poption spacer"></span>
                    <input class="poption Attack" type="checkbox" name="attr_attack" value="1" /><span class="poption">Attack:</span>
                        <select class="suboption attackoptions" name="attr_attack-type">
                            <option value="STR">Melee(STR)</option>
                            <option value="DEX">Ranged(DEX)</option>
                            <option value="INT">Intelligence based</option>
                            <option value="CHA">Charisma based</option>
                            <option value="WIS">Wisdom based</option>
                            <option value="CON">Constitution based</option>
                            <option value="MWEAP1">Melee Weapon 1</option>
                            <option value="MWEAP2">Melee Weapon 2</option>
                            <option value="MWEAP3">Melee Weapon 3</option>
                            <option value="RWEAP1">Ranged Weapon 1</option>
                            <option value="RWEAP2">Ranged Weapon 2</option>
                            <option value="RWEAP3">Ranged Weapon 3</option>
                            <option value="CUSTOM">Custom</option>
                        </select>
                        <input class="suboption attackoptions title" type="text" name="attr_attack-custom" style="width:55px;" placeholder="3" />
                        <span class="spacer suboption attackoptions" style="height: 1px;"></span>
                        <span class="suboption attackoptions" style="margin-left: 20px;">VS:</span>
                        <select class="suboption attackoptions" name="attr_attack-vstype">
                            <option value="AC">AC</option>
                            <option value="PD">PD</option>
                            <option value="MD">MD</option>
                            <option value="CUSTOM">Custom</option>
                        </select>
                        <input class="suboption attackoptions title" type="text" name="attr_attack-vscustom" style="width:55px;" placeholder="Custom" />
                        <span class="poption spacer"></span>
                    <input class="poption Cust1" type="checkbox" name="attr_cust1" value="1" /><span class="poption">Custom 1</span>
                        <span class="spacer suboption cust1options"></span>
                        <input class="suboption cust1options cust1-hit" type="radio" name="attr_cust1-type" value="Hit" /><span class="suboption cust1options">Hit</span>
                        <input class="suboption cust1options cust1-miss" type="radio" name="attr_cust1-type" value="Miss" /><span class="suboption cust1options">Miss</span>
                        <input class="suboption cust1options cust1-trigger" type="radio" name="attr_cust1-type" value="Trigger" /><span class="suboption cust1options">Trigger</span>
                        <input class="suboption cust1options cust1-effect" type="radio" name="attr_cust1-type" value="Effect" /><span class="suboption cust1options">Effect</span>
                        <input class="suboption cust1options cust1-improved" type="radio" name="attr_cust1-type" value="Improved" /><span class="suboption cust1options">Improved</span>
                        <input class="suboption cust1options cust1-sustain" type="radio" name="attr_cust1-type" value="Sustain" /><span class="suboption cust1options">Sustain</span>
                        <input class="suboption cust1options cust1-special" type="radio" name="attr_cust1-type" value="Special" /><span class="suboption cust1options">Special</span>
                        <input class="suboption cust1options cust1-opening-sustaining-effect" type="radio" name="attr_cust1-type" value="Opening-Sustaining-Effect" /><span class="suboption cust1options" style="width:190px;">Opening-Sustaining-Effect</span>
                        <input class="suboption cust1options cust1-final-verse" type="radio" name="attr_cust1-type" value="Final-Verse" /><span class="suboption cust1options">Final-Verse</span>
                        <input class="suboption cust1options cust1-details" type="radio" name="attr_cust1-type" value="Details" /><span class="suboption cust1options" style="width:100px;">Details</span>
                        <input class="suboption cust1options cust1-attackcustom" type="radio" name="attr_cust1-type" value="typecustom" /><span class="suboption cust1options">Custom</span>
                        <input class="suboption cust1options title" type="text" name="attr_cust1-custom" style="width:75px;" placeholder="Custom" />
                        <span class="spacer subption cust1options"></span>
                        <input class="suboption cust1options cust1subcust1" type="checkbox" name="attr_cust1-subcust1" value="1" />
                            <input class="suboption cust1options title full" type="text" name="attr_cust1-subcust1-desc" />
                        <input class="suboption cust1options cust1subcust2" type="checkbox" name="attr_cust1-subcust2" value="1" />
                            <input class="suboption cust1options title full" type="text" name="attr_cust1-subcust2-desc" />
                        <input class="suboption cust1options cust1subcust3" type="checkbox" name="attr_cust1-subcust3" value="1" />
                            <input class="suboption cust1options title full" type="text" name="attr_cust1-subcust3-desc" />
                        <input class="suboption cust1options cust1subcust4" type="checkbox" name="attr_cust1-subcust4" value="1" />
                            <input class="suboption cust1options title full" type="text" name="attr_cust1-subcust4-desc" />
                    <input class="poption Cust2" type="checkbox" name="attr_cust2" value="1" /><span class="poption">Custom 2</span>
                        <span class="spacer suboption cust2options"></span>
                        <input class="suboption cust2options cust2-hit" type="radio" name="attr_cust2-type" value="Hit" /><span class="suboption cust2options">Hit</span>
                        <input class="suboption cust2options cust2-miss" type="radio" name="attr_cust2-type" value="Miss" /><span class="suboption cust2options">Miss</span>
                        <input class="suboption cust2options cust2-trigger" type="radio" name="attr_cust2-type" value="Trigger" /><span class="suboption cust2options">Trigger</span>
                        <input class="suboption cust2options cust2-effect" type="radio" name="attr_cust2-type" value="Effect" /><span class="suboption cust2options">Effect</span>
                        <input class="suboption cust2options cust2-improved" type="radio" name="attr_cust2-type" value="Improved" /><span class="suboption cust2options">Improved</span>
                        <input class="suboption cust2options cust2-sustain" type="radio" name="attr_cust2-type" value="Sustain" /><span class="suboption cust2options">Sustain</span>
                        <input class="suboption cust2options cust2-special" type="radio" name="attr_cust2-type" value="Special" /><span class="suboption cust2options">Special</span>
                        <input class="suboption cust2options cust2-opening-sustaining-effect" type="radio" name="attr_cust2-type" value="Opening-Sustaining-Effect" /><span class="suboption cust2options" style="width:190px;">Opening-Sustaining-Effect</span>
                        <input class="suboption cust2options cust2-final-verse" type="radio" name="attr_cust2-type" value="Final-Verse" /><span class="suboption cust2options">Final-Verse</span>
                        <input class="suboption cust2options cust2-details" type="radio" name="attr_cust2-type" value="Details" /><span class="suboption cust2options" style="width:100px;">Details</span>
                        <input class="suboption cust2options cust2-attackcustom" type="radio" name="attr_cust2-type" value="typecustom" /><span class="suboption cust2options">Custom</span>
                        <input class="suboption cust2options title" type="text" name="attr_cust2-custom" style="width:55px;" placeholder="Custom" />
                        <span class="spacer subption cust2options"></span>
                        <input class="suboption cust2options cust2subcust1" type="checkbox" name="attr_cust2-subcust1" value="1" />
                            <input class="suboption cust2options title full" type="text" name="attr_cust2-subcust1-desc" />
                        <input class="suboption cust2options cust2subcust2" type="checkbox" name="attr_cust2-subcust2" value="1" />
                            <input class="suboption cust2options title full" type="text" name="attr_cust2-subcust2-desc" />
                        <input class="suboption cust2options cust2subcust3" type="checkbox" name="attr_cust2-subcust3" value="1" />
                            <input class="suboption cust2options title full" type="text" name="attr_cust2-subcust3-desc" />
                        <input class="suboption cust2options cust2subcust4" type="checkbox" name="attr_cust2-subcust4" value="1" />
                            <input class="suboption cust2options title full" type="text" name="attr_cust2-subcust4-desc" />
                    <input class="poption Cust3" type="checkbox" name="attr_cust3" value="1" /><span class="poption">Custom 3</span>
                        <span class="spacer suboption cust3options"></span>
                        <input class="suboption cust3options cust3-hit" type="radio" name="attr_cust3-type" value="Hit" /><span class="suboption cust3options">Hit</span>
                        <input class="suboption cust3options cust3-miss" type="radio" name="attr_cust3-type" value="Miss" /><span class="suboption cust3options">Miss</span>
                        <input class="suboption cust3options cust3-trigger" type="radio" name="attr_cust3-type" value="Trigger" /><span class="suboption cust3options">Trigger</span>
                        <input class="suboption cust3options cust3-effect" type="radio" name="attr_cust3-type" value="Effect" /><span class="suboption cust3options">Effect</span>
                        <input class="suboption cust3options cust3-improved" type="radio" name="attr_cust3-type" value="Improved" /><span class="suboption cust3options">Improved</span>
                        <input class="suboption cust3options cust3-sustain" type="radio" name="attr_cust3-type" value="Sustain" /><span class="suboption cust3options">Sustain</span>
                        <input class="suboption cust3options cust3-special" type="radio" name="attr_cust3-type" value="Special" /><span class="suboption cust3options">Special</span>
                        <input class="suboption cust3options cust3-opening-sustaining-effect" type="radio" name="attr_cust3-type" value="Opening-Sustaining-Effect" /><span class="suboption cust3options" style="width:190px;">Opening-Sustaining-Effect</span>
                        <input class="suboption cust3options cust3-final-verse" type="radio" name="attr_cust3-type" value="Final-Verse" /><span class="suboption cust3options">Final-Verse</span>
                        <input class="suboption cust3options cust3-details" type="radio" name="attr_cust3-type" value="Details" /><span class="suboption cust3options" style="width:100px;">Details</span>
                        <input class="suboption cust3options cust3-attackcustom" type="radio" name="attr_cust3-type" value="typecustom" /><span class="suboption cust3options">Custom</span>
                        <input class="suboption cust3options title" type="text" name="attr_cust3-custom" style="width:55px;" placeholder="Custom" />
                        <span class="spacer subption cust3options"></span>
                        <input class="suboption cust3options cust3subcust1" type="checkbox" name="attr_cust3-subcust1" value="1" />
                            <input class="suboption cust3options title full" type="text" name="attr_cust3-subcust1-desc" />
                        <input class="suboption cust3options cust3subcust2" type="checkbox" name="attr_cust3-subcust2" value="1" />
                            <input class="suboption cust3options title full" type="text" name="attr_cust3-subcust2-desc" />
                        <input class="suboption cust3options cust3subcust3" type="checkbox" name="attr_cust3-subcust3" value="1" />
                            <input class="suboption cust3options title full" type="text" name="attr_cust3-subcust3-desc" />
                        <input class="suboption cust3options cust3subcust4" type="checkbox" name="attr_cust3-subcust4" value="1" />
                            <input class="suboption cust3options title full" type="text" name="attr_cust3-subcust4-desc" />
                    <!-- TEMPLATE -->
                    <input type="number" name="attr_flag" value="0" />
                    <input type="hidden" name="attr_power-roll" value="" />
                    <div class="header">
                        <button class="powerlabel" type="roll" name="roll_power" value="@{power-roll}">
                            <span class="label" name="attr_powname-display"></span>
                        </button>
                        <div style="position: absolute; top: 5px; right: -8px;">
                            <input class="1" type="checkbox" name="attr_uses1" />
                            <input class="2" type="checkbox" name="attr_uses2" />
                            <input class="3" type="checkbox" name="attr_uses3" />
                            <input class="4" type="checkbox" name="attr_uses4" />
                            <span class="label" name="attr_type-display"></span>
                        </div>
                    </div>
                    <div class="repbody">
                        <span class="action-range">
                            <span class="left action">
                                <span class="label bold" name="attr_action-display"></span>
                            </span>
                            <span class="right range">
                                <span class="label bold" name="attr_range-display"></span>
                            </span>
                        </span>
                        <span class="left target">
                            <b>Target:</b>
                            <span class="label" name="attr_target-display" style="width: 180px;"></span>
                        </span>
                        <span class="left attack">
                            <b>Attack:</b>
                            <span class="label" name="attr_attack-display" style="width: 115px; text-align: left;"></span>
                        </span>
                        <span class="left cust1">
                            <span class="label bold toplineleft" name="attr_cust1-display"></span>
                            <span class="cust1subcust1 toplineright" name="attr_cust1-subcust1-display"></span>
                            <span class="cust1subcust2 fuller" name="attr_cust1-subcust2-display"></span>
                            <span class="cust1subcust3 fuller" name="attr_cust1-subcust3-display"></span>
                            <span class="cust1subcust4 fuller" name="attr_cust1-subcust4-display"></span>
                        </span>
                        <span class="left cust2">
                            <span class="label bold toplineleft" name="attr_cust2-display"></span>
                            <span class="cust2subcust1 toplineright" name="attr_cust2-subcust1-display"></span>
                            <span class="cust2subcust2 fuller" name="attr_cust2-subcust2-display"></span>
                            <span class="cust2subcust3 fuller" name="attr_cust2-subcust3-display"></span>
                            <span class="cust2subcust4 fuller" name="attr_cust2-subcust4-display"></span>
                        </span>
                        <span class="left cust3">
                            <span class="label bold toplineleft" name="attr_cust3-display"></span>
                            <span class="cust3subcust1 toplineright" name="attr_cust3-subcust1-display"></span>
                            <span class="cust3subcust2 fuller" name="attr_cust3-subcust2-display"></span>
                            <span class="cust3subcust3 fuller" name="attr_cust3-subcust3-display"></span>
                            <span class="cust3subcust4 fuller" name="attr_cust3-subcust4-display"></span>
                        </span>
                    </div>
                </div>
            </fieldset>



        </div>
    </div>

<!-- HIDDEN FIELDS USED FOR CALCULATIONS -->
<input type="hidden" disabled="true" name="attr_E-DIE" value="[[&{noerror}(((((@{tracker|Escalation Die}+0) + (6)) - abs((@{tracker|Escalation Die}+0) - (6))) / 2))]][E-DIE]" />

</div>

<div class="footer" style="font-size: 10px; color: rgb(165, 165, 165);">
    <span>
        &copy;2015 Pelgrane Press Ltd.  Published by Pelgrane Press Ltd. under license from Fire Opal Media. The 13th Age is a trademarks of Fire Opal Media, Inc.
    </span>
</div>

<!-- ROLL TEMPLATES -->
<rolltemplate class="sheet-rolltemplate-attr">
    <div class="header">
        <span class="headerlabel">{{attr}}</span>
        {{#back}}
            <span class="headerdivider">]</span>
            <span class="headerlabel">{{back}}</span>
        {{/back}}
    </div>
    <div class="body">
        <div class="part">
            <span class="partlabel">{{attr_abr}}</span>
            <span class="partnumber">{{attr_bonus}}</span>
        </div>
        <div class="partspacer">+</div>
        <div class="part">
            <span class="partlabel">LVL</span>
            <span class="partnumber">{{level}}</span>
        </div>
        {{#back}}
            <div class="partspacer">+</div>
            <div class="part">
                <span class="partlabel">BCK</span>
                <span class="partnumber">{{back_bonus}}</span>
            </div>
        {{/back}}
        {{#rollGreater() mod 0}}
            <div class="partspacer">+</div>
            <div class="part">
                <span class="partlabel">MOD</span>
                <span class="partnumber">{{mod}}</span>
            </div>
        {{/rollGreater() mod 0}}
        {{#rollLess() mod 0}}
            <div class="partspacer">+</div>
            <div class="part">
                <span class="partlabel">MOD</span>
                <span class="partnumber">{{mod}}</span>
            </div>
        {{/rollLess() mod 0}}
        <div class="partspacer">=</div>
        <div class="result">{{result}}</div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-init">
    <div class="header">
        <span class="headerlabel">Initiative</span>
        <span class="headerdivider">]</span>
        <span class="headerlabel">{{name}}</span>
    </div>
    <div class="body">
        <div class="part">
            <span class="partlabel">DEX</span>
            <span class="partnumber">{{dex_bonus}}</span>
        </div>
        <div class="partspacer">+</div>
        <div class="part">
            <span class="partlabel">LVL</span>
            <span class="partnumber">{{level}}</span>
        </div>
        {{#rollGreater() mod 0}}
            <div class="partspacer">+</div>
            <div class="part">
                <span class="partlabel">MOD</span>
                <span class="partnumber">{{mod}}</span>
            </div>
        {{/rollGreater() mod 0}}
        {{#rollLess() mod 0}}
            <div class="partspacer">+</div>
            <div class="part">
                <span class="partlabel">MOD</span>
                <span class="partnumber">{{mod}}</span>
            </div>
        {{/rollLess() mod 0}}
        <div class="partspacer">=</div>
        <div class="result">{{result}}</div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-deathsave">
    <div class="header">
        <span class="headerlabel">Death Save</span>
    </div>
    <div class="body">
        <div class="partspacer"> </div>
        <div class="result">{{result}}</div>
        <div class="partspacer"> </div>
        {{#rollWasCrit() result}}
            <div class="part">
                <span class="partlabel">CRITICAL SUCCESS</span>
                <span class="partnumber">Use a recovery and take an action!</span>
            </div>
        {{/rollWasCrit() result}}
        {{#rollBetween() result 16 19}}
            <div class="part">
                <span class="partlabel">SUCCESS</span>
                <span class="partnumber">Use a recovery!</span>
            </div>
        {{/rollBetween() result 16 19}}
        {{#rollLess() result 16}}
            <div class="part">
                <span class="partlabel">FAILURE</span>
                <span class="partnumber">Mark a step toward death!</span>
            </div>
        {{/rollLess() result 16}}
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-icon">
    <div class="header">
        <span class="headerlabel">{{name}}</span>
        <span class="headerdivider">]</span>
        <span class="headerlabel">{{relationship}}</span>
    </div>
    <div class="body">
        {{#rollGreater() iconlvl 0}}
            <div class="part">
                {{#rollTotal() icon1 5}}
                    <span class="partlabel">e</span>
                {{/rollTotal() icon1 5}}
                {{#rollTotal() icon1 6}}
                    <span class="partlabel">k</span>
                {{/rollTotal() icon1 6}}
                <span class="partnumber">{{icon1}}</span>
            </div>
        {{/rollGreater() iconlvl 0}}
        {{#rollGreater() iconlvl 1}}
            <div class="partspacer">j</div>
            <div class="part">
                {{#rollTotal() icon2 5}}
                    <span class="partlabel">e</span>
                {{/rollTotal() icon2 5}}
                {{#rollTotal() icon2 6}}
                    <span class="partlabel">k</span>
                {{/rollTotal() icon2 6}}
                <span class="partnumber">{{icon2}}</span>
            </div>
        {{/rollGreater() iconlvl 1}}
        {{#rollGreater() iconlvl 2}}
            <div class="partspacer">j</div>
            <div class="part">
                {{#rollTotal() icon3 5}}
                    <span class="partlabel">e</span>
                {{/rollTotal() icon3 5}}
                {{#rollTotal() icon3 6}}
                    <span class="partlabel">k</span>
                {{/rollTotal() icon3 6}}
                <span class="partnumber">{{icon3}}</span>
            </div>
        {{/rollGreater() iconlvl 2}}
        {{#rollGreater() iconlvl 3}}
            <div class="partspacer">j</div>
            <div class="part">
                {{#rollTotal() icon4 5}}
                    <span class="partlabel">e</span>
                {{/rollTotal() icon4 5}}
                {{#rollTotal() icon4 6}}
                    <span class="partlabel">k</span>
                {{/rollTotal() icon4 6}}
                <span class="partnumber">{{icon4}}</span>
            </div>
        {{/rollGreater() iconlvl 3}}
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-rec">
    <div class="header">
        <span class="headerlabel">Recovery</span>
    </div>
    <div class="body">
        <div class="part">
            <span class="partlabel">LVL</span>
            <span class="partnumber">{{level}}</span>
        </div>
        <div class="partspacer">d</div>
        <div class="part">
            <span class="partlabel">REC</span>
            <span class="partnumber">{{rec_die}}</span>
        </div>
        <div class="partspacer">+</div>
        <div class="part">
            <span class="partlabel">CON</span>
            <span class="partnumber">{{con_bonus}}</span>
        </div>
        {{#rollGreater() mod 0}}
            <div class="partspacer">+</div>
            <div class="part">
                <span class="partlabel">MOD</span>
                <span class="partnumber">{{mod}}</span>
            </div>
        {{/rollGreater() mod 0}}
        {{#rollLess() mod 0}}
            <div class="partspacer">+</div>
            <div class="part">
                <span class="partlabel">MOD</span>
                <span class="partnumber">{{mod}}</span>
            </div>
        {{/rollLess() mod 0}}
        <div class="partspacer">=</div>
        <div class="result">{{result}}</div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-ba">
    <div class="header atwill">
        <span class="headerlabel left">{{wname}}</span>
        <span class="headerlabel right">At-Will</span>
    </div>
    <div class="body">
        <div class="row">
            <span class="left bold">Standard Action</span>
            <span class="right bold">{{range}}</span>
        </div>
        <div class="row">
            <span class="left"><b>Target:</b> One Creature</span>
        </div>
        <div class="row">
            <span class="left"><b>Attack:</b> {{attbonus}} vs AC</span>
        </div>
        <div class="row" style="margin-bottom: 5px;">
            <span class="left"><b>Hit:</b> {{damage}}</span>
            <span class="right"><b>Miss:</b> {{miss}}</span>
        </div>
    </div>
</rolltemplate>

<rolltemplate class="sheet-rolltemplate-power">
    {{#atwill}}
        <div class="header atwill">
    {{/atwill}}
    {{#class}}
        <div class="header class">
    {{/class}}
    {{#racial-encounter}}
        <div class="header racial-encounter">
    {{/racial-encounter}}
    {{#recharge-daily}}
        <div class="header recharge-daily">
    {{/recharge-daily}}
    {{#spell}}
        <div class="header spell">
    {{/spell}}
    {{#magicitem}}
        <div class="header magicitem">
    {{/magicitem}}
    {{#typecustom}}
        <div class="header custom">
    {{/typecustom}}
        <span class="headerlabel left">{{name}}</span>
        <span class="headerlabel right">{{type}}</span>
    </div>
    <div class="body">
        {{#action-range-flag}}
        <div class="row">
            <span class="left bold">{{action}}</span>
            <span class="right bold">{{range}}</span>
        </div>
        {{/action-range-flag}}
        {{#target}}
        <div class="row">
            <span class="left"><b>Target:</b> {{target}}</span>
        </div>
        {{/target}}
        {{#attack}}
        <div class="row">
            <span class="left"><b>Attack:</b> {{attbonus}} vs {{vstype}}</span>
        </div>
        {{/attack}}
        {{#cust1}}
            <div class="row">
                {{#Hit-1}}
                    <span class="bold left">Hit: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Hit-1}}
                {{#Miss-1}}
                    <span class="bold left">Miss: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Miss-1}}
                {{#Trigger-1}}
                    <span class="bold left">Trigger: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Trigger-1}}
                {{#Effect-1}}
                    <span class="bold left">Effect: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Effect-1}}
                {{#Sustain-1}}
                    <span class="bold left">Sustain: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Sustain-1}}
                {{#Improved-1}}
                    <span class="bold left">Improved: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Improved-1}}
                {{#Opening-Sustaining-Effect-1}}
                    <span class="bold left">Opening/Sustaining Effect: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Opening-Sustaining-Effect-1}}
                {{#Final-Verse-1}}
                    <span class="bold left">Final Verse: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Final-Verse-1}}
                {{#Special-1}}
                    <span class="bold left">Special: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Special-1}}
                {{#Details-1}}
                    <span class="bold left">Details: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/Details-1}}
                {{#typecustom-1}}
                    <span class="bold left">{{custype1}}: </span><span style="width:10px;">{{cust1-subcust1-desc}}</span>
                {{/typecustom-1}}
            </div>
                {{#cust1-subcust2}}
                    <div class="row">
                        <span class="left">{{cust1-subcust2-desc}}</span>
                    </div>
                {{/cust1-subcust2}}
                {{#cust1-subcust3}}
                    <div class="row">
                        <span class="left">{{cust1-subcust3-desc}}</span>
                    </div>
                {{/cust1-subcust3}}
                {{#cust1-subcust4}}
                    <div class="row">
                        <span class="left">{{cust1-subcust4-desc}}</span>
                    </div>
                {{/cust1-subcust4}}
        {{/cust1}}
        {{#cust2}}
            <div class="row">
                {{#Hit-2}}
                    <span class="bold left">Hit: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Hit-2}}
                {{#Miss-2}}
                    <span class="bold left">Miss: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Miss-2}}
                {{#Trigger-2}}
                    <span class="bold left">Trigger: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Trigger-2}}
                {{#Effect-2}}
                    <span class="bold left">Effect: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Effect-2}}
                {{#Sustain-2}}
                    <span class="bold left">Sustain: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Sustain-2}}
                {{#Improved-2}}
                    <span class="bold left">Improved: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Improved-2}}
                {{#Opening-Sustaining-Effect-2}}
                    <span class="bold left">Opening/Sustaining Effect: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Opening-Sustaining-Effect-2}}
                {{#Final-Verse-2}}
                    <span class="bold left">Final Verse: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Final-Verse-2}}
                {{#Special-2}}
                    <span class="bold left">Special: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Special-2}}
                {{#Details-2}}
                    <span class="bold left">Details: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/Details-2}}
                {{#typecustom-2}}
                    <span class="bold left">{{custype2}}: </span><span style="width:10px;">{{cust2-subcust1-desc}}</span>
                {{/typecustom-2}}
            </div>
                {{#cust2-subcust2}}
                    <div class="row">
                        <span class="left">{{cust2-subcust2-desc}}</span>
                    </div>
                {{/cust2-subcust2}}
                {{#cust2-subcust3}}
                    <div class="row">
                         <span class="left">{{cust2-subcust3-desc}}</span>
                    </div>
                {{/cust2-subcust3}}
                {{#cust2-subcust4}}
                    <div class="row">
                         <span class="left">{{cust2-subcust4-desc}}</span>
                    </div>
                {{/cust2-subcust4}}
        {{/cust2}}
        {{#cust3}}
            <div class="row">
                {{#Hit-3}}
                    <span class="bold left">Hit: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Hit-3}}
                {{#Miss-3}}
                    <span class="bold left">Miss: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Miss-3}}
                {{#Trigger-3}}
                    <span class="bold left">Trigger: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Trigger-3}}
                {{#Effect-3}}
                    <span class="bold left">Effect: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Effect-3}}
                {{#Sustain-3}}
                    <span class="bold left">Sustain: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Sustain-3}}
                {{#Improved-3}}
                    <span class="bold left">Improved: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Improved-3}}
                {{#Opening-Sustaining-Effect-3}}
                    <span class="bold left">Opening/Sustaining Effect: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Opening-Sustaining-Effect-3}}
                {{#Final-Verse-3}}
                    <span class="bold left">Final Verse: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Final-Verse-3}}
                {{#Special-3}}
                    <span class="bold left">Special: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Special-3}}
                {{#Details-3}}
                    <span class="bold left">Details: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/Details-3}}
                {{#typecustom-3}}
                    <span class="bold left">{{custype3}}: </span><span style="width:10px;">{{cust3-subcust1-desc}}</span>
                {{/typecustom-3}}
            </div>
                {{#cust3-subcust2}}
                    <div class="row">
                         <span class="left">{{cust3-subcust2-desc}}</span>
                    </div>
                {{/cust3-subcust2}}
                {{#cust3-subcust3}}
                    <div class="row">
                         <span class="left">{{cust3-subcust3-desc}}</span>
                    </div>
                {{/cust3-subcust3}}
                {{#cust3-subcust4}}
                    <div class="row">
                         <span class="left">{{cust3-subcust4-desc}}</span>
                    </div>
                {{/cust3-subcust4}}
        {{/cust3}}
    </div>
</rolltemplate>

<!-- WORKERS -->
<script type="text/worker">
    /* === EVENTS === */
    // Version handling
    on("sheet:opened", function(eventinfo) {
        versioning();
    });

    // Abilities
    on("change:str-base", function(e) {
        setAttrs({"STR-mod": Math.floor((parseInt(e.newValue) - 10) / 2)});
    });
    on("change:con-base", function(e) {
        setAttrs({"CON-mod": Math.floor((parseInt(e.newValue) - 10) / 2)});
    });
    on("change:dex-base", function(e) {
        setAttrs({"DEX-mod": Math.floor((parseInt(e.newValue) - 10) / 2)});
    });
    on("change:int-base", function(e) {
        setAttrs({"INT-mod": Math.floor((parseInt(e.newValue) - 10) / 2)});
    });
    on("change:wis-base", function(e) {
        setAttrs({"WIS-mod": Math.floor((parseInt(e.newValue) - 10) / 2)});
    });
    on("change:cha-base", function(e) {
        setAttrs({"CHA-mod": Math.floor((parseInt(e.newValue) - 10) / 2)});
    });

    // Level / AC / PD / MD / HP / Weapons (mods level) / Powers (mods level)
    on("change:ac-base change:str-mod change:con-mod change:dex-mod change:int-mod change:wis-mod change:cha-mod change:pd-base change:md-base change:hp-base change:hp-mod change:level change:m-miss change:r-miss",function(e){
        if (["level","m-miss","r-miss"].includes(e.sourceAttribute)) {updateLvl()}
        if (["level","ac-base","con-mod","dex-mod","wis-mod"].includes(e.sourceAttribute)) {updateAc()}
        if (["level","pd-base","str-mod","con-mod","dex-mod"].includes(e.sourceAttribute)) {updatePd()}
        if (["level","md-base","int-mod","wis-mod","cha-mod"].includes(e.sourceAttribute)) {updateMd()}
        if (["level","hp-base","hp-mod","con-mod"].includes(e.sourceAttribute)) {updateHp()}
        if (["level","con-mod"].includes(e.sourceAttribute)) {updateRec()}
        if (["level","str-mod","dex-mod"].includes(e.sourceAttribute)) {
            getAttrs(["MWEAP-sel","RWEAP-sel"], function(v){
                updateMeleeWeapon(parseInt(v["MWEAP-sel"]) || 1);
                updateRangeWeapon(parseInt(v["RWEAP-sel"]) || 1);
            });
        }
        if (["level","str-mod","con-mod","dex-mod","int-mod","wis-mod","cha-mod"].includes(e.sourceAttribute)) {updateAllPowers()}
    });

    // Background
    on("change:back-sel", function(e){
        updateBckgrd(parseInt(e.newValue) || 1);
    });
    on("change:BACK-name1 change:BACK1 change:BACK-name2 change:BACK2 change:BACK-name3 change:BACK3 change:BACK-name4 change:BACK4 change:BACK-name5 change:BACK5 change:BACK-name6 change:BACK6 change:BACK-name7 change:BACK7 change:BACK-name8 change:BACK8 change:BACK-name9 change:BACK9 change:BACK-name10 change:BACK10", function(e){
        getAttrs(["BACK-sel"], function(v){
            if((e.sourceAttribute == "back-name"+v["BACK-sel"]) || (e.sourceAttribute == "back"+v["BACK-sel"])){updateBckgrd(parseInt(v["BACK-sel"]) || 1);}
        });
    });

    // Recovery
    on("change:rec_max", function(e) {
        getAttrs(["REC_max"], function(v) {
            setAttrs({
               "rec_flag": v.REC_max
            });
        });
    });

    // Powers
    on("change:repeating_power:flag change:repeating_power:name change:repeating_power:type change:repeating_power:classtype change:repeating_power:type-custom change:repeating_power:rechargerate change:repeating_power:uses change:repeating_power:action change:repeating_power:action-type change:repeating_power:action-custom change:repeating_power:range change:repeating_power:range-type change:repeating_power:range-custom change:repeating_power:target change:repeating_power:target-type change:repeating_power:attack change:repeating_power:attack-type change:repeating_power:attack-custom change:repeating_power:attack-vstype change:repeating_power:attack-vscustom change:repeating_power:cust1 change:repeating_power:cust1-type change:repeating_power:cust1-custom change:repeating_power:cust1-subcust1 change:repeating_power:cust1-subcust2 change:repeating_power:cust1-subcust3 change:repeating_power:cust1-subcust4 change:repeating_power:cust1-subcust1-desc change:repeating_power:cust1-subcust2-desc change:repeating_power:cust1-subcust3-desc change:repeating_power:cust1-subcust4-desc change:repeating_power:cust2 change:repeating_power:cust2-type change:repeating_power:cust2-custom change:repeating_power:cust2-subcust1 change:repeating_power:cust2-subcust2 change:repeating_power:cust2-subcust3 change:repeating_power:cust2-subcust4 change:repeating_power:cust2-subcust1-desc change:repeating_power:cust2-subcust2-desc change:repeating_power:cust2-subcust3-desc change:repeating_power:cust2-subcust4-desc change:repeating_power:cust3 change:repeating_power:cust3-type change:repeating_power:cust3-custom change:repeating_power:cust3-subcust1 change:repeating_power:cust3-subcust2 change:repeating_power:cust3-subcust3 change:repeating_power:cust3-subcust4 change:repeating_power:cust3-subcust1-desc change:repeating_power:cust3-subcust2-desc change:repeating_power:cust3-subcust3-desc change:repeating_power:cust3-subcust4-desc", function(e) {
        updatePower(e);
    });

    // Selected Melee Weapon
    on("change:mweap-sel", function(e){
        updateMeleeWeapon(parseInt(e.newValue) || 1);
    });
    on("change:mweap-mod1 change:mweap-mod2 change:mweap-mod3 change:mweap1 change:mweap2 change:mweap3 change:m-bamod", function(e) {
        getAttrs(["MWEAP-sel"], function(v){
            if((e.sourceAttribute == "m-bamod") || (e.sourceAttribute == "mweap-mod"+v["MWEAP-sel"]) || (e.sourceAttribute == "mweap"+v["MWEAP-sel"])){updateMeleeWeapon(parseInt(v["MWEAP-sel"]) || 1);}
        });
    });
    //Selected Range Weapon
    on("change:rweap-sel", function(e){
        updateRangeWeapon(parseInt(e.newValue) || 1);
    });
    on("change:rweap-mod1 change:rweap-mod2 change:rweap-mod3 change:rweap1 change:rweap2 change:rweap3 change:r-bamod", function(e) {
        getAttrs(["RWEAP-sel"], function(v){
            if((e.sourceAttribute == "r-bamod") || (e.sourceAttribute == "rweap-mod"+v["RWEAP-sel"]) || (e.sourceAttribute == "rweap"+v["RWEAP-sel"])){
                updateRangeWeapon(parseInt(v["RWEAP-sel"]) || 1);
            }
        });
    });

    // Icons
    on("change:icon1-5 change:icon2-5 change:icon3-5 change:icon4-5 change:icon5-5 change:icon1-6 change:icon2-6 change:icon3-6 change:icon4-6 change:icon5-6", function() {
        getAttrs(["icon1-5","icon2-5","icon3-5","icon4-5","icon5-5","icon1-6","icon2-6","icon3-6","icon4-6","icon5-6","icon1-5-count","icon2-5-count","icon3-5-count","icon4-5-count","icon5-5-count","icon1-6-count","icon2-6-count","icon3-6-count","icon4-6-count","icon5-6-count"], function(v) {
            var setAttrsObj = {};
            for(var input in v) {
                if(v[input] == "0" && typeof v[input+"-count"] !== "undefined" && (""+v[input+"-count"]).trim() !== "") {
                    setAttrsObj[input+"-count"] = 0;
                }
            }
            setAttrs(setAttrsObj);
        });
    });
    on("change:icon1-5-count change:icon2-5-count change:icon3-5-count change:icon4-5-count change:icon5-5-count change:icon1-6-count change:icon2-6-count change:icon3-6-count change:icon4-6-count change:icon5-6-count", function() {
        getAttrs(["icon1-5-count","icon2-5-count","icon3-5-count","icon4-5-count","icon5-5-count","icon1-6-count","icon2-6-count","icon3-6-count","icon4-6-count","icon5-6-count"], function(v) {
            var setAttrsObj = {},
                inputs = ["icon1-5-count","icon2-5-count","icon3-5-count","icon4-5-count","icon5-5-count","icon1-6-count","icon2-6-count","icon3-6-count","icon4-6-count","icon5-6-count"];
            _.each(inputs, function(input) {
                if(typeof v[input] === "undefined" || (""+v[input]).trim() === "") {
                    setAttrsObj[input.substr(0, input.indexOf("-count"))] = "0";
                }
                else if(v[input] && isNaN(v[input]) === false && (""+v[input]).trim() !== "0") {
                    setAttrsObj[input.substr(0, input.indexOf("-count"))] = "on";
                    setAttrsObj[input] = (typeof v[input] === "String") ? v[input].trim() : v[input];
                }
                else {
                    setAttrsObj[input.substr(0, input.indexOf("-count"))] = "0";
                    setAttrsObj[input] = 0;
                }
            });
            setAttrs(setAttrsObj);
        });
    });

    /* === FUNCTIONS === */
    // Level
    var updateLvl = function() {
        getAttrs(["level","M-MISS","R-MISS"], function (v) {
            var mlt = 1, mmiss = 0, rmiss = 0, newlvl = parseInt(v["level"]) || 1;
            if (newlvl > 7) {mlt=3;}
            else if (newlvl > 4) {mlt=2;}
            if (v["M-MISS"] != "0") {mmiss = newlvl;}
            if (v["R-MISS"] != "0") {rmiss = newlvl;}
            setAttrs({
                "LVL-multiplier": mlt,
                "MBA-miss": mmiss,
                "RBA-miss": rmiss
            });
        });
    };
    // AC
    var updateAc = function() {
        getAttrs(["level","AC-base","CON-mod","DEX-mod","WIS-mod"], function(v){
            var modarr = _.sortBy([parseInt(v["CON-mod"]),parseInt(v["DEX-mod"]),parseInt(v["WIS-mod"])], function(num) {return num;});
            setAttrs({"AC": parseInt(v["AC-base"])+parseInt(v["level"])+modarr[1]});
        });
    };
    // PD
    var updatePd = function() {
        getAttrs(["level","PD-base","STR-mod","CON-mod","DEX-mod"], function(v){
            var modarr = _.sortBy([parseInt(v["STR-mod"]),parseInt(v["CON-mod"]),parseInt(v["DEX-mod"])], function(num) {return num;});
            setAttrs({"PD": parseInt(v["PD-base"])+parseInt(v["level"])+modarr[1]});
        });
    };
    // MD
    var updateMd = function() {
        getAttrs(["level","MD-base","INT-mod","WIS-mod","CHA-mod"], function(v){
            var modarr = _.sortBy([parseInt(v["INT-mod"]),parseInt(v["WIS-mod"]),parseInt(v["CHA-mod"])], function(num) {return num;});
            setAttrs({"MD": parseInt(v["MD-base"])+parseInt(v["level"])+modarr[1]});
        });
    };
    // HP
    var updateHp = function() {
        getAttrs(["level","HP-base","HP-mod","CON-mod"], function(v){
            var lvl = 0, mod4 = 0, hpmulti = 0, hpmax = 0;
            lvl = parseInt(v["level"]) || 1;
            mod4 = lvl % 4;
            hpmulti = lvl + 2 + (Math.floor(lvl/4) * mod4) + (Math.floor(lvl/8) * (6 + mod4));
            hpmax = ((parseInt(v["HP-base"])+parseInt(v["CON-mod"])) * hpmulti) + parseInt(v["HP-mod"]);
            setAttrs({
                "HP_max": hpmax,
                "HP-staggered": Math.floor(hpmax/2)
            });
        });
    };
    // Recovery
    var updateRec = function () {
        getAttrs(["level","CON-mod","REC-bonus"], function(v){
            var newrec = 0, mlt = 1, lvl = parseInt(v["level"]) || 1, oldrec = parseInt(v["REC-bonus"]) || 0;
            if (lvl > 7) {mlt=3;}
            else if (lvl > 4) {mlt=2;}
            newrec = (parseInt(v["CON-mod"]) || 0) * mlt;
            if (Math.abs(newrec) > Math.abs(oldrec)) {setAttrs({"REC-bonus": newrec});}
        });
    };
    // Background
    var updateBckgrd = function(bcknb) {
        getAttrs(["BACK"+bcknb,"BACK-name"+bcknb], function (v) {
            var backval = parseInt(v["BACK"+bcknb]) || 0;
            setAttrs({"BACK-final": "[[" + backval + "]][BCK]]]}} {{back=" + v["BACK-name"+bcknb] + "}} {{back_bonus="+ backval + "}}"});
        });
    };

    // Powers
    var updateAllPowers = function() {
        getSectionIDs("repeating_power", function(idarray) {
            console.log("*** DEBUG updateAllPowers");
            var flag = "", obj = {}, attrs = [];
            for(var i=0; i < idarray.length; i++) {
                //TODO : Doesn't trigger, have to really change the value (date time ?)
                //Set a flag to trigger the power full update (updatePower())
                attrs = [];
                flag = "repeating_power_" + idarray[i] + "_flag";
                attrs.push(flag)
                console.log("*** DEBUG updateAllPowers flag id " + flag);
                getAttrs(attrs, function (v){
                    console.log("*** DEBUG updateAllPowers flag value " + v[flag]);
                    obj = {};
                    obj[flag] = (parseInt(v[flag]) || 0) + 1;
                    setAttrs(obj);
                });
            }
        });
    };
    var updatePower = function(e) {
        /*if (typeof e !== "undefined") {
            console.log("*** DEBUG updatePower " + e.sourceAttribute);
        }*/
        getAttrs(["STR-mod","DEX-mod","CON-mod","INT-mod","CHA-mod","WIS-mod","level","MWEAP-mod1","MWEAP-mod2","MWEAP-mod3","RWEAP-mod1","RWEAP-mod2","RWEAP-mod3","repeating_power_name","repeating_power_type","repeating_power_type-custom","repeating_power_uses","repeating_power_action","repeating_power_action-type","repeating_power_action-custom","repeating_power_range","repeating_power_range-type","repeating_power_range-custom","repeating_power_target","repeating_power_target-type","repeating_power_attack","repeating_power_attack-type","repeating_power_attack-custom","repeating_power_attack-vstype","repeating_power_attack-vscustom","repeating_power_cust1","repeating_power_cust1-type","repeating_power_cust1-custom","repeating_power_cust1-subcust1","repeating_power_cust1-subcust2","repeating_power_cust1-subcust3","repeating_power_cust1-subcust4","repeating_power_cust1-subcust1-desc","repeating_power_cust1-subcust2-desc","repeating_power_cust1-subcust3-desc","repeating_power_cust1-subcust4-desc","repeating_power_cust2","repeating_power_cust2-type","repeating_power_cust2-custom","repeating_power_cust2-subcust1","repeating_power_cust2-subcust2","repeating_power_cust2-subcust3","repeating_power_cust2-subcust4","repeating_power_cust2-subcust1-desc","repeating_power_cust2-subcust2-desc","repeating_power_cust2-subcust3-desc","repeating_power_cust2-subcust4-desc","repeating_power_cust3","repeating_power_cust3-type","repeating_power_cust3-custom","repeating_power_cust3-subcust1","repeating_power_cust3-subcust2","repeating_power_cust3-subcust3","repeating_power_cust3-subcust4","repeating_power_cust3-subcust1-desc","repeating_power_cust3-subcust2-desc","repeating_power_cust3-subcust3-desc","repeating_power_cust3-subcust4-desc","repeating_power_classtype","race","repeating_power_rechargerate"], function(v) {
            var str = parseInt(v["STR-mod"]) || 0
                dex = parseInt(v["DEX-mod"]) || 0,
                con = parseInt(v["CON-mod"]) || 0,
                int = parseInt(v["INT-mod"]) || 0,
                wis = parseInt(v["WIS-mod"]) || 0,
                cha = parseInt(v["CHA-mod"]) || 0,
                mweap1 = parseInt(v["MWEAP-mod1"]) || 0,
                mweap2 = parseInt(v["MWEAP-mod2"]) || 0,
                mweap3 = parseInt(v["MWEAP-mod3"]) || 0,
                rweap1 = parseInt(v["RWEAP-mod1"]) || 0,
                rweap2 = parseInt(v["RWEAP-mod2"]) || 0,
                rweap3 = parseInt(v["RWEAP-mod3"]) || 0,
                level = parseInt(v["level"]) || 1
                type = "",
                action = "",
                range = "",
                attack = 0,
                attackvs = "",
                vs = "",
                cust1type = "",
                cust2type = "",
                cust3type = "",
                roll = "&{template:power} {{name=" + v.repeating_power_name + "}}";
            // === Power Roll & Display
            // TYPE
            switch(v.repeating_power_type) {
                case "atwill":
                    type = "At-Will"; //to translate
                    roll += " {{atwill=1}} {{type=At-Will}}";
                    break;
                case "class":
                    switch(v.repeating_power_classtype) {
                        case "Talent":
                            type = "Talent"; //to translate
                            break;
                        case "Feature":
                            type = "Feature"; //to translate
                            break;
                        case "Power":
                            type = "Power"; //to translate
                            break;
                        case "Battle Cry":
                            type = "Battle Cry"; //to translate
                            break;
                        case "Domain":
                            type = "Domain"; //to translate
                            break;
                    }
                    roll += " {{class=1}} {{type=" + type + "}}";
                    break;
                case "racial":
                    type = v.race;
                    roll += " {{racial-encounter=1}} {{type=" + v.race + "}}";
                    break;
                case "encounter":
                    type = "Encounter"; //to translate
                    roll += " {{racial-encounter=1}} {{type=" + type + "}}";
                    break;
                case "recharge":
                    type = "Recharge+" + v.repeating_power_rechargerate; //to translate
                    roll += " {{recharge-daily=1}} {{type=" + v["repeating_power_rechargerate"] + "+}}";
                    break;
                case "daily":
                    type = "Daily"; //to translate
                    roll += " {{recharge-daily=1}} {{type=" + type + "}}";
                    break;
                case "spell":
                    type = "Spell"; //to translate
                    roll += " {{spell=1}} {{type=" + type + "}}";
                    break;
                case "magicitem":
                    type = "Magic Item"; //to translate
                    roll += " {{magicitem=1}} {{type=" + type + "}}";
                    break;
                case "custom":
                    type = v["repeating_power_type-custom"];
                    roll += " {{typecustom=1}} {{type=" + type + "}}";
                    break;
            }
            // Action and/or Range roll template line
            if ((v.repeating_power_action == "1") || (v.repeating_power_range == "1")) {
                roll +=" {{action-range-flag=1}}";
            }
            // ACTION
            if (v.repeating_power_action == "1") {
                switch(v["repeating_power_action-type"]) {
                    case "Standard Action":
                        action = "Standard Action"; //to translate
                        break;
                    case "Move Action":
                        action = "Move Action"; //to translate
                        break;
                    case "Quick Action":
                        action = "Quick Action"; //to translate
                        break;
                    case "Free Action":
                        action = "Free Action"; //to translate
                        break;
                    case "Flexible Action":
                        action = "Flexible Action"; //to translate
                        break;
                    case "Custom":
                        action = v["repeating_power_action-custom"];
                        break;
                }
                roll += " {{action=" + action + "}}";
            }
            // RANGE
            if(v.repeating_power_range == "1") {
                switch(v["repeating_power_range-type"]) {
                    case "Engaged":
                        range = "Engaged"; //to translate
                        break;
                    case "Nearby":
                        range = "Nearby"; //to translate
                        break;
                    case "Far Away":
                        range = "Far Away"; //to translate
                        break;
                    case "Line of Sight":
                        range = "Line of Sight"; //to translate
                        break;
                    case "Custom":
                        range = v["repeating_power_range-custom"];
                        break;
                }
                roll += " {{range=" + range + "}}";
            }
            //TARGET
            if(v.repeating_power_target == "1") {
               roll += " {{target=" + v["repeating_power_target-type"] + "}}";
            }
            // ATTACK
            if(v.repeating_power_attack == "1") {
                roll += " {{attack=1}} {{attbonus=[[1d20+";
                switch(v["repeating_power_attack-type"]) {
                    case "STR":
                        attack = str + level;
                        roll += "" + str + "[STR]+" + level + "[LVL]"; //to translate
                        break;
                    case "CON":
                        attack = con + level;
                        roll += "" + con + "[CON]+" + level + "[LVL]"; //to translate
                        break;
                    case "DEX":
                        attack = dex + level;
                        roll += "" + dex + "[DEX]+" + level + "[LVL]"; //to translate
                        break;
                    case "INT":
                        attack = int + level;
                        roll += "" + int + "[INT]+" + level + "[LVL]"; //to translate
                        break;
                    case "WIS":
                        attack = wis + level
                        roll += "" + wis + "[WIS]+" + level + "[LVL]"; //to translate
                        break;
                    case "CHA":
                        attack = cha + level;
                        roll += "" + cha + "[CHA]+" + level + "[LVL]"; //to translate
                        break;
                    case "MWEAP1":
                        attack = str + level + mweap1;
                        roll += "" + str + "[STR]+" + level + "[LVL]+" + mweap1 + "[WEAP]"; //to translate
                        break;
                    case "MWEAP2":
                        attack = str + level + mweap2;
                        roll += "" + str + "[STR]+" + level + "[LVL]+" + mweap2 + "[WEAP]"; //to translate
                        break;
                    case "MWPEA3":
                        attack = str + level + mweap3;
                        roll += "" + str + "[STR]+" + level + "[LVL]+" + mweap3 + "[WEAP]"; //to translate
                        break;
                    case "RWEAP1":
                        attack = dex + level + rweap1;
                        roll += "" + dex + "[DEX]+" + level + "[LVL]+" + rweap1 + "[WEAP]"; //to translate
                        break;
                    case "RWEAP2":
                        attack = dex + level + rweap2;
                        roll += "" + dex + "[DEX]+" + level + "[LVL]+" + rweap2 + "[WEAP]"; //to translate
                        break;
                    case "RWEAP3":
                        attack = dex + level + rweap3;
                        roll += "" + dex + "[DEX]+" + level + "[LVL]+" + rweap3 + "[WEAP]"; //to translate
                        break;
                    case "CUSTOM":
                        attack = parseInt(v["repeating_power_attack-custom"]) || 0;
                        roll += v["repeating_power_attack-custom"];
                        break;
                    default:
                        roll += "0[UNKNOW]"; //to translate
                        break;
                }
                roll += "+?{Modifiers|0}[MOD]+@{E-DIE}]]}}"; //to translate
                // VS
                switch(v["repeating_power_attack-vstype"]) {
                    case "AC":
                        vs = "AC"; // to translate
                        break;
                    case "PD":
                        vs = "PD"; // to translate
                        break;
                    case "MD":
                        vs = "MD"; // to translate
                        break;
                    case "CUSTOM":
                        vs = v["repeating_power_attack-vscustom"];
                        break;
                }
                roll +=" {{vstype=" + vs + "}}";
                attackvs = (attack < 0 ? "" : "+") + attack + " vs " + vs; // to translate
            }
            // CUSTOM 1
            if(v.repeating_power_cust1 == "1") {
                roll += " {{cust1=1}} {{" + v["repeating_power_cust1-type"] + "-1=1}}";
                switch(v["repeating_power_cust1-type"]) {
                    case "Hit":
                        cust1type = "Hit"; //to translate
                        break;
                    case "Miss":
                        cust1type = "Miss"; //to translate
                        break;
                    case "Trigger":
                        cust1type = "Trigger"; //to translate
                        break;
                    case "Effect":
                        cust1type = "Effect"; //to translate
                        break;
                    case "Improved":
                        cust1type = "Improved"; //to translate
                        break;
                    case "Sustain":
                        cust1type = "Sustain"; //to translate
                        break;
                    case "Special":
                        cust1type = "Special"; //to translate
                        break;
                    case "Opening-Sustaining-Effect":
                        cust1type = "Opening-Sustaining-Effect"; //to translate
                        break;
                    case "Final-Verse":
                        cust1type = "Final-Verse"; //to translate
                        break;
                    case "Details":
                        cust1type = "Details"; //to translate
                        break;
                    case "typecustom":
                        cust1type = v["repeating_power_cust1-custom"];
                        roll += " {{custype1=" + cust1type + "}}";
                        break;
                }
                cust1type += ":";
                if(v["repeating_power_cust1-subcust1"] == "1") {
                    roll += " {{cust1-subcust1=1}} {{cust1-subcust1-desc=" + v["repeating_power_cust1-subcust1-desc"] + "}}";
                }
                if(v["repeating_power_cust1-subcust2"] == "1") {
                    roll += " {{cust1-subcust2=1}} {{cust1-subcust2-desc=" + v["repeating_power_cust1-subcust2-desc"] + "}}";
                }
                if(v["repeating_power_cust1-subcust3"] == "1") {
                    roll += " {{cust1-subcust3=1}} {{cust1-subcust3-desc=" + v["repeating_power_cust1-subcust3-desc"] + "}}";
                }
                if(v["repeating_power_cust1-subcust4"] == "1") {
                    roll += " {{cust1-subcust4=1}} {{cust1-subcust4-desc=" + v["repeating_power_cust1-subcust4-desc"] + "}}";
                }
            }
            // CUSTOM 2
            if(v.repeating_power_cust2 == "1") {
                roll += " {{cust2=1}} {{" + v["repeating_power_cust2-type"] + "-2=1}}";
                switch(v["repeating_power_cust2-type"]) {
                    case "Hit":
                        cust2type = "Hit"; //to translate
                        break;
                    case "Miss":
                        cust2type = "Miss"; //to translate
                        break;
                    case "Trigger":
                        cust2type = "Trigger"; //to translate
                        break;
                    case "Effect":
                        cust2type = "Effect"; //to translate
                        break;
                    case "Improved":
                        cust2type = "Improved"; //to translate
                        break;
                    case "Sustain":
                        cust2type = "Sustain"; //to translate
                        break;
                    case "Special":
                        cust2type = "Special"; //to translate
                        break;
                    case "Opening-Sustaining-Effect":
                        cust2type = "Opening-Sustaining-Effect"; //to translate
                        break;
                    case "Final-Verse":
                        cust2type = "Final-Verse"; //to translate
                        break;
                    case "Details":
                        cust2type = "Details"; //to translate
                        break;
                    case "typecustom":
                        cust2type = v["repeating_power_cust2-custom"];
                        roll += " {{custype2=" + cust2type + "}}";
                        break;
                }
                cust2type += ":";
                if(v["repeating_power_cust2-subcust1"] == "1") {
                    roll += " {{cust2-subcust1=1}} {{cust2-subcust1-desc=" + v["repeating_power_cust2-subcust1-desc"] + "}}";
                }
                if(v["repeating_power_cust2-subcust2"] == "1") {
                    roll += " {{cust2-subcust2=1}} {{cust2-subcust2-desc=" + v["repeating_power_cust2-subcust2-desc"] + "}}";
                }
                if(v["repeating_power_cust2-subcust3"] == "1") {
                    roll += " {{cust2-subcust3=1}} {{cust2-subcust3-desc=" + v["repeating_power_cust2-subcust3-desc"] + "}}";
                }
                if(v["repeating_power_cust2-subcust4"] == "1") {
                    roll += " {{cust2-subcust4=1}} {{cust2-subcust4-desc=" + v["repeating_power_cust2-subcust4-desc"] + "}}";
                }
            }
            // CUSTOM 3
            if(v.repeating_power_cust3 == "1") {
                roll += " {{cust3=1}} {{" + v["repeating_power_cust3-type"] + "-3=1}}";
                switch(v["repeating_power_cust3-type"]) {
                    case "Hit":
                        cust3type = "Hit"; //to translate
                        break;
                    case "Miss":
                        cust3type = "Miss"; //to translate
                        break;
                    case "Trigger":
                        cust3type = "Trigger"; //to translate
                        break;
                    case "Effect":
                        cust3type = "Effect"; //to translate
                        break;
                    case "Improved":
                        cust3type = "Improved"; //to translate
                        break;
                    case "Sustain":
                        cust3type = "Sustain"; //to translate
                        break;
                    case "Special":
                        cust3type = "Special"; //to translate
                        break;
                    case "Opening-Sustaining-Effect":
                        cust3type = "Opening-Sustaining-Effect"; //to translate
                        break;
                    case "Final-Verse":
                        cust3type = "Final-Verse"; //to translate
                        break;
                    case "Details":
                        cust3type = "Details"; //to translate
                        break;
                    case "typecustom":
                        cust3type = v["repeating_power_cust3-custom"];
                        roll += " {{custype3=" + cust3type + "}}";
                        break;
                }
                cust3type += ":";
                if(v["repeating_power_cust3-subcust1"] == "1") {
                    roll += " {{cust3-subcust1=1}} {{cust3-subcust1-desc=" + v["repeating_power_cust3-subcust1-desc"] + "}}";
                }
                if(v["repeating_power_cust3-subcust2"] == "1") {
                    roll += " {{cust3-subcust2=1}} {{cust3-subcust2-desc=" + v["repeating_power_cust3-subcust2-desc"] + "}}";
                }
                if(v["repeating_power_cust3-subcust3"] == "1") {
                    roll += " {{cust3-subcust3=1}} {{cust3-subcust3-desc=" + v["repeating_power_cust3-subcust3-desc"] + "}}";
                }
                if(v["repeating_power_cust3-subcust4"] == "1") {
                    roll += " {{cust3-subcust4=1}} {{cust3-subcust4-desc=" + v["repeating_power_cust3-subcust4-desc"] + "}}";
                }
            }
            // UPDATE
            console.log("*** DEBUG power roll:" + roll);
            setAttrs({
                "repeating_power_power-roll" : roll,
                "repeating_power_powname-display": v["repeating_power_name"],
                "repeating_power_type-display": type,
                "repeating_power_action-display": action,
                "repeating_power_range-display": range,
                "repeating_power_target-display": v["repeating_power_target-type"],
                "repeating_power_attack-display": attackvs,
                "repeating_power_cust1-display": cust1type,
                "repeating_power_cust1-subcust1-display": v["repeating_power_cust1-subcust1-desc"],
                "repeating_power_cust1-subcust2-display": v["repeating_power_cust1-subcust2-desc"],
                "repeating_power_cust1-subcust3-display": v["repeating_power_cust1-subcust3-desc"],
                "repeating_power_cust1-subcust4-display": v["repeating_power_cust1-subcust4-desc"],
                "repeating_power_cust2-display": cust2type,
                "repeating_power_cust2-subcust1-display": v["repeating_power_cust2-subcust1-desc"],
                "repeating_power_cust2-subcust2-display": v["repeating_power_cust2-subcust2-desc"],
                "repeating_power_cust2-subcust3-display": v["repeating_power_cust2-subcust3-desc"],
                "repeating_power_cust2-subcust4-display": v["repeating_power_cust2-subcust4-desc"],
                "repeating_power_cust3-display": cust3type,
                "repeating_power_cust3-subcust1-display": v["repeating_power_cust3-subcust1-desc"],
                "repeating_power_cust3-subcust2-display": v["repeating_power_cust3-subcust2-desc"],
                "repeating_power_cust3-subcust3-display": v["repeating_power_cust3-subcust3-desc"],
                "repeating_power_cust3-subcust4-display": v["repeating_power_cust3-subcust4-desc"]
            });
        });
    };

    // Weapons -- how to: multinlingual handling ?
    var updateMeleeWeapon = function(i) {
        var mwsel = parseInt(i) || 1;
        getAttrs(["level","MWEAP-mod"+mwsel,"MWEAP"+mwsel,"M-BAMOD","STR-mod","DEX-mod","LVL-multiplier"], function(v) {
            var str = parseInt(v["STR-mod"]) || 0,
                dex = parseInt(v["DEX-mod"]) || 0,
                mweap = parseInt(v["MWEAP-mod"+mwsel]) || 0,
                level = parseInt(v["level"]) || 1,
                lvlmultiplier = parseInt(v["LVL-multiplier"]) || 1,
                mattmod = v["M-BAMOD"] === "@{STR-mod}" ? str : dex,
                mattackvs = "",
                mhit = "",
                mfinal = "";
            mfinal = "{{wname=@{MWEAP-name"+mwsel+"}}} {{attbonus=[[1d20+[[@{M-BAMOD}]][MMOD]+@{level}[LVL]+@{MWEAP-mod"+mwsel+"}[WEAP]+?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{damage=[[@{level}d[[@{MWEAP"+mwsel+"}]]+@{MWEAP-mod"+mwsel+"}[WEAP]+[[(@{M-BAMOD}*@{LVL-multiplier})]]]]}}";
            mattackvs = (parseInt(level + mattmod + mweap) < 0 ? "" : "+") + (level + mattmod + mweap) + " vs AC";
            mhit = level + "d" + v["MWEAP"+mwsel] + (((mattmod*lvlmultiplier)+mweap) < 0 ? "" : "+") + ((mattmod*lvlmultiplier)+mweap);
            setAttrs({
                "MWEAP-final": mfinal,
                "MBA-attackvs": mattackvs,
                "MBA-hit": mhit,
            });
        });
    };
    var updateRangeWeapon = function(i) {
        var rwsel = parseInt(i) || 1;
        getAttrs(["level","RWEAP-mod"+rwsel,"RWEAP"+rwsel,"R-BAMOD","STR-mod","DEX-mod","LVL-multiplier"], function(v) {
            var str = parseInt(v["STR-mod"]) || 0,
                dex = parseInt(v["DEX-mod"]) || 0,
                rweap = parseInt(v["RWEAP-mod"+rwsel]) || 0,
                level = parseInt(v["level"]) || 1,
                lvlmultiplier = parseInt(v["LVL-multiplier"]) || 1,
                rattmod = v["R-BAMOD"] === "@{STR-mod}" ? str : dex,
                rattackvs = "",
                rhit = "",
                rfinal = "";
            rfinal = "{{wname=@{RWEAP-name"+rwsel+"}}} {{attbonus=[[1d20+[[@{R-BAMOD}]][RMOD]+@{level}[LVL]+@{RWEAP-mod"+rwsel+"}[WEAP]+?{Modifiers|0}[MOD]+@{E-DIE}]]}} {{damage=[[@{level}d[[@{RWEAP"+rwsel+"}]]+@{RWEAP-mod"+rwsel+"}[WEAP]+[[(@{R-BAMOD}*@{LVL-multiplier})]]]]}}";
            rattackvs = (parseInt(level + rattmod + rweap) < 0 ? "" : "+") + (level + rattmod + rweap) + " vs AC";
            rhit = level + "d" + v["RWEAP"+rwsel] + (parseInt((rattmod*lvlmultiplier)+rweap) < 0 ? "" : "+") + ((rattmod*lvlmultiplier)+rweap);
            setAttrs({
                "RWEAP-final": rfinal,
                "RBA-attackvs": rattackvs,
                "RBA-hit": rhit
            });
        });
    };


    //Version and updating
    var upgrade_to_2_0 = function(doneupdating) {
        // Ability mods to sheet-worker
        getAttrs(["STR-base","CON-base","DEX-base","INT-base","WIS-base","CHA-base","REC-bonus"], function(v) {
            var callback = function() {
                updateLvl();
                updateAc();
                updatePd();
                updateMd();
                updateHp();
                updateBckgrd(1);
                updateRec();
                updateMeleeWeapon(1);
                updateRangeWeapon(1);
            };
            var conmod = Math.floor((parseInt(v["CON-base"]) - 10) / 2);
            setAttrs({
               "STR-mod": Math.floor((parseInt(v["STR-base"]) - 10) / 2),
               "CON-mod": conmod,
               "REC-bonus": Math.max(conmod, parseInt(v["REC-bonus"]) || 0),
               "DEX-mod": Math.floor((parseInt(v["DEX-base"]) - 10) / 2),
               "INT-mod": Math.floor((parseInt(v["INT-base"]) - 10) / 2),
               "WIS-mod": Math.floor((parseInt(v["WIS-base"]) - 10) / 2),
               "CHA-mod": Math.floor((parseInt(v["CHA-base"]) - 10) / 2),
                },{silent: true},callback);
            doneupdating();
        });
    };

    var versioning = function() {
        getAttrs(["version"], function(v) {
            var vrs = parseFloat(v["version"]) || 1.0;
            if (vrs == 2.0) {
                console.log("13th Age by Roll20 v" + vrs);
                return;
            }
            else if (vrs < 2.0) {
                console.log("UPGRADING TO v2.0");
                upgrade_to_2_0(function() {
                    setAttrs({"version": "2.0"});
                    versioning();
                });
            }
        });
    };
</script>
